"use strict";

require("source-map-support/register");

const {
  _,
  eachAsync_
} = require('rk-utils');

const {
  InvalidArgument,
  Forbidden
} = require('@genx/error');

class FiniteStateMachine {
  constructor(app, transitionTable, stateFetcher, stateUpdater) {
    this.app = app;
    this.transitions = transitionTable;
    this.stateFetcher_ = stateFetcher;
    this.stateUpdater_ = stateUpdater;
  }

  async getAllowedActions_(context, withDisallowedReason) {
    const currentState = await this.stateFetcher_(this.app, context);
    const transitions = this.transitions[currentState];

    if (!transitions) {
      throw new InvalidArgument(`State "${currentState}" rules not found in the transition table.`);
    }

    const allowed = [],
          disallowed = [];
    await eachAsync_(transitions, async (rule, action) => {
      const [actionAllowed, disallowedReason] = rule.when && (await rule.when(this.app, context)) || FiniteStateMachine.OK;

      if (actionAllowed) {
        allowed.push({
          action,
          desc: rule.desc,
          targetState: rule.target
        });
      } else if (withDisallowedReason) {
        disallowed.push({
          action,
          desc: rule.desc,
          targetState: rule.target,
          reason: disallowedReason
        });
      }
    });
    const ret = {
      allowed
    };

    if (withDisallowedReason) {
      ret.disallowed = disallowed;
    }

    return ret;
  }

  async performAction_(action, context, payload, updateOpts, connOpts) {
    const currentState = await this.stateFetcher_(this.app, context, connOpts);
    const transitions = this.transitions[currentState];

    if (!transitions) {
      throw new InvalidArgument(`State "${currentState}" rules not found in the transition table.`);
    }

    const rule = transitions && transitions[action];

    if (!rule) {
      throw new Forbidden(`Action "${action}" is not allowed in "${currentState}" state.`);
    }

    if (rule.when) {
      const [allowed, disallowedReason] = await rule.when(this.app, context);

      if (!allowed) {
        throw new Forbidden(disallowedReason || `The current state does not meet the requirements of "${action}" action.`);
      }
    }

    const entityUpdate = rule.before && (await rule.before(this.app, context, payload)) || { ...payload
    };
    const [actuallyUpdated, updateResult] = await this.stateUpdater_(this.app, context, entityUpdate, rule.target, updateOpts, connOpts);

    if (actuallyUpdated && rule.after) {
      await rule.after(this.app, context, connOpts);
    }

    return updateResult;
  }

}

FiniteStateMachine.OK = [true];

FiniteStateMachine.fail = reason => [false, reason];

FiniteStateMachine.triggerAll_ = array => (...args) => eachAsync_(array, action_ => action_(...args));

FiniteStateMachine.ifAny = array => async (...args) => {
  let l = array.length,
      reason = [];

  for (let i = 0; i < l; i++) {
    const checker_ = array[i];
    const [allowed, disallowedReason] = await checker_(...args);

    if (allowed) {
      return FiniteStateMachine.OK;
    }

    reason.push(disallowedReason);
  }

  return FiniteStateMachine.fail('None of the required conditions met.\n' + reason.join('\n'));
};

FiniteStateMachine.ifAll = array => async (...args) => {
  let l = array.length;

  for (let i = 0; i < l; i++) {
    const checker_ = array[i];
    const [allowed, disallowedReason] = await checker_(...args);

    if (!allowed) {
      return FiniteStateMachine.fail(disallowedReason);
    }
  }

  return FiniteStateMachine.OK;
};

module.exports = FiniteStateMachine;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9GaW5pdGVTdGF0ZU1hY2hpbmUuanMiXSwibmFtZXMiOlsiXyIsImVhY2hBc3luY18iLCJyZXF1aXJlIiwiSW52YWxpZEFyZ3VtZW50IiwiRm9yYmlkZGVuIiwiRmluaXRlU3RhdGVNYWNoaW5lIiwiY29uc3RydWN0b3IiLCJhcHAiLCJ0cmFuc2l0aW9uVGFibGUiLCJzdGF0ZUZldGNoZXIiLCJzdGF0ZVVwZGF0ZXIiLCJ0cmFuc2l0aW9ucyIsInN0YXRlRmV0Y2hlcl8iLCJzdGF0ZVVwZGF0ZXJfIiwiZ2V0QWxsb3dlZEFjdGlvbnNfIiwiY29udGV4dCIsIndpdGhEaXNhbGxvd2VkUmVhc29uIiwiY3VycmVudFN0YXRlIiwiYWxsb3dlZCIsImRpc2FsbG93ZWQiLCJydWxlIiwiYWN0aW9uIiwiYWN0aW9uQWxsb3dlZCIsImRpc2FsbG93ZWRSZWFzb24iLCJ3aGVuIiwiT0siLCJwdXNoIiwiZGVzYyIsInRhcmdldFN0YXRlIiwidGFyZ2V0IiwicmVhc29uIiwicmV0IiwicGVyZm9ybUFjdGlvbl8iLCJwYXlsb2FkIiwidXBkYXRlT3B0cyIsImNvbm5PcHRzIiwiZW50aXR5VXBkYXRlIiwiYmVmb3JlIiwiYWN0dWFsbHlVcGRhdGVkIiwidXBkYXRlUmVzdWx0IiwiYWZ0ZXIiLCJmYWlsIiwidHJpZ2dlckFsbF8iLCJhcnJheSIsImFyZ3MiLCJhY3Rpb25fIiwiaWZBbnkiLCJsIiwibGVuZ3RoIiwiaSIsImNoZWNrZXJfIiwiam9pbiIsImlmQWxsIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE1BQU07QUFBRUEsRUFBQUEsQ0FBRjtBQUFLQyxFQUFBQTtBQUFMLElBQW9CQyxPQUFPLENBQUMsVUFBRCxDQUFqQzs7QUFDQSxNQUFNO0FBQUVDLEVBQUFBLGVBQUY7QUFBbUJDLEVBQUFBO0FBQW5CLElBQWlDRixPQUFPLENBQUMsYUFBRCxDQUE5Qzs7QUFZQSxNQUFNRyxrQkFBTixDQUF5QjtBQW1DckJDLEVBQUFBLFdB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QWpCIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgeyBfLCBlYWNoQXN5bmNfIH0gPSByZXF1aXJlKCdyay11dGlscycpO1xuY29uc3QgeyBJbnZhbGlkQXJndW1lbnQsIEZvcmJpZGRlbiB9ID0gcmVxdWlyZSgnQGdlbngvZXJyb3InKTtcblxuLyoqXG4gKiBcbiAqIEFjdGlvbiBydWxlOiBcbiAqICBkZXNjOiBkZXNjcmlwdGlvbiBvZiB0aGlzIHRyYW5zaXRpb25cbiAqICB3aGVuOiBwcmUgdHJhbnNpdGlvbiBjb25kaXRpb24gY2hlY2tcbiAqICB0YXJnZXQ6IHRhcmdldCBzdGF0ZVxuICogIGJlZm9yZTogdHJhbnNmb3JtaW5nIGJlZm9yZSBhcHBseWluZyB0byB0aGUgc3RhdGUgXG4gKiAgYWZ0ZXI6IHRyaWdnZXIgYW5vdGhlciBhY3Rpb24gYWZ0ZXIgdHJhbnNpdGlvblxuICovXG5cbmNsYXNzIEZpbml0ZVN0YXRlTWFjaGluZSB7ICAgIFxuICAgIHN0YXRpYyBPSyA9IFt0cnVlXTtcbiAgICBzdGF0aWMgZmFpbCA9IChyZWFzb24pID0+IFtmYWxzZSwgcmVhc29uXTtcbiAgICBzdGF0aWMgdHJpZ2dlckFsbF8gPSAoYXJyYXkpID0+ICguLi5hcmdzKSA9PiBlYWNoQXN5bmNfKGFycmF5LCBhY3Rpb25fID0+IGFjdGlvbl8oLi4uYXJncykpO1xuICAgIHN0YXRpYyBpZkFueSA9IChhcnJheSkgPT4gYXN5bmMgKC4uLmFyZ3MpID0+IHtcbiAgICAgICAgbGV0IGwgPSBhcnJheS5sZW5ndGgsIHJlYXNvbiA9IFtdO1xuXG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbDsgaSsrKSB7XG4gICAgICAgICAgICBjb25zdCBjaGVja2VyXyA9IGFycmF5W2ldO1xuXG4gICAgICAgICAgICBjb25zdCBbIGFsbG93ZWQsIGRpc2FsbG93ZWRSZWFzb24gXSA9IGF3YWl0IGNoZWNrZXJfKC4uLmFyZ3MpO1xuICAgICAgICAgICAgaWYgKGFsbG93ZWQpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gRmluaXRlU3RhdGVNYWNoaW5lLk9LO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICByZWFzb24ucHVzaChkaXNhbGxvd2VkUmVhc29uKTtcbiAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgcmV0dXJuIEZpbml0ZVN0YXRlTWFjaGluZS5mYWlsKCdOb25lIG9mIHRoZSByZXF1aXJlZCBjb25kaXRpb25zIG1ldC5cXG4nICsgcmVhc29uLmpvaW4oJ1xcbicpKTtcbiAgICB9O1xuICAgIHN0YXRpYyBpZkFsbCA9IGFycmF5ID0+IGFzeW5jICguLi5hcmdzKSA9PiB7XG4gICAgICAgIGxldCBsID0gYXJyYXkubGVuZ3RoO1xuXG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbDsgaSsrKSB7XG4gICAgICAgICAgICBjb25zdCBjaGVja2VyXyA9IGFycmF5W2ldO1xuXG4gICAgICAgICAgICBjb25zdCBbIGFsbG93ZWQsIGRpc2FsbG93ZWRSZWFzb24gXSA9IGF3YWl0IGNoZWNrZXJfKC4uLmFyZ3MpO1xuICAgICAgICAgICAgaWYgKCFhbGxvd2VkKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIEZpbml0ZVN0YXRlTWFjaGluZS5mYWlsKGRpc2FsbG93ZWRSZWFzb24pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICByZXR1cm4gRmluaXRlU3RhdGVNYWNoaW5lLk9LO1xuICAgIH07XG5cbiAgICBjb25zdHJ1Y3RvcihhcHAsIHRyYW5zaXRpb25UYWJsZSwgc3RhdGVGZXRjaGVyLCBzdGF0ZVVwZGF0ZXIpIHtcbiAgICAgICAgdGhpcy5hcHAgPSBhcHA7XG5cbiAgICAgICAgdGhpcy50cmFuc2l0aW9ucyA9IHRyYW5zaXRpb25UYWJsZTtcbiAgICAgICAgdGhpcy5zdGF0ZUZldGNoZXJfID0gc3RhdGVGZXRjaGVyO1xuICAgICAgICB0aGlzLnN0YXRlVXBkYXRlcl8gPSBzdGF0ZVVwZGF0ZXI7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0IGEgbGlzdCBvZiBhbGxvd2VkIGFjdGlvbnMgYmFzZWQgb24gdGhlIGN1cnJlbnQgc3RhdGUuICAgICBcbiAgICAgKiBAcGFyYW0geyp9IGNvbnRleHQgXG4gICAgICogQHBhcmFtIHtib29sZWFufSB3aXRoRGlzYWxsb3dlZFJlYXNvblxuICAgICAqL1xuICAgIGFzeW5jIGdldEFsbG93ZWRBY3Rpb25zXyhjb250ZXh0LCB3aXRoRGlzYWxsb3dlZFJlYXNvbikge1xuICAgICAgICBjb25zdCBjdXJyZW50U3RhdGUgPSBhd2FpdCB0aGlzLnN0YXRlRmV0Y2hlcl8odGhpcy5hcHAsIGNvbnRleHQpO1xuXG4gICAgICAgIC8vZnJvbSBzdGF0ZVxuICAgICAgICBjb25zdCB0cmFuc2l0aW9ucyA9IHRoaXMudHJhbnNpdGlvbnNbY3VycmVudFN0YXRlXTsgICAgXG4gICAgICAgIGlmICghdHJhbnNpdGlvbnMpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBJbnZhbGlkQXJndW1lbnQoYFN0YXRlIFwiJHtjdXJyZW50U3RhdGV9XCIgcnVsZXMgbm90IGZvdW5kIGluIHRoZSB0cmFuc2l0aW9uIHRhYmxlLmApO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgYWxsb3dlZCA9IFtdLCBkaXNhbGxvd2VkID0gW107ICAgIFxuXG4gICAgICAgIGF3YWl0IGVhY2hBc3luY18odHJhbnNpdGlvbnMsIGFzeW5jIChydWxlLCBhY3Rpb24pID0+IHtcbiAgICAgICAgICAgIGNvbnN0IFsgYWN0aW9uQWxsb3dlZCwgZGlzYWxsb3dlZFJlYXNvbiBdID0gKHJ1bGUud2hlbiAmJiBhd2FpdCBydWxlLndoZW4odGhpcy5hcHAsIGNvbnRleHQpKSB8fCBGaW5pdGVTdGF0ZU1hY2hpbmUuT0s7XG5cbiAgICAgICAgICAgIGlmIChhY3Rpb25BbGxvd2VkKSB7XG4gICAgICAgICAgICAgICAgYWxsb3dlZC5wdXNoKHtcbiAgICAgICAgICAgICAgICAgICAgYWN0aW9uLFxuICAgICAgICAgICAgICAgICAgICBkZXNjOiBydWxlLmRlc2MsXG4gICAgICAgICAgICAgICAgICAgIHRhcmdldFN0YXRlOiBydWxlLnRhcmdldFxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfSBlbHNlIGlmICh3aXRoRGlzYWxsb3dlZFJlYXNvbikge1xuICAgICAgICAgICAgICAgIGRpc2FsbG93ZWQucHVzaCh7XG4gICAgICAgICAgICAgICAgICAgIGFjdGlvbixcbiAgICAgICAgICAgICAgICAgICAgZGVzYzogcnVsZS5kZXNjLFxuICAgICAgICAgICAgICAgICAgICB0YXJnZXRTdGF0ZTogcnVsZS50YXJnZXQsXG4gICAgICAgICAgICAgICAgICAgIHJlYXNvbjogZGlzYWxsb3dlZFJlYXNvblxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICBjb25zdCByZXQgPSB7XG4gICAgICAgICAgICBhbGxvd2VkXG4gICAgICAgIH07XG5cbiAgICAgICAgaWYgKHdpdGhEaXNhbGxvd2VkUmVhc29uKSB7XG4gICAgICAgICAgICByZXQuZGlzYWxsb3dlZCA9IGRpc2FsbG93ZWQ7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gcmV0O1xuICAgIH1cbiAgICBcbiAgICAvKipcbiAgICAgKiBQZXJmb3JtIHRoZSBzcGVjaWZpZWQgYWN0aW9uLlxuICAgICAqIEBwYXJhbSB7Kn0gYWN0aW9uIFxuICAgICAqIEBwYXJhbSB7Kn0gY29udGV4dCAgICAgXG4gICAgICogQHBhcmFtIHsqfSBwYXlsb2FkIFxuICAgICAqIEBwYXJhbSB7Kn0gdXBkYXRlT3B0cyBcbiAgICAgKiBAcGFyYW0geyp9IGNvbm5PcHRzIFxuICAgICAqL1xuICAgIGFzeW5jIHBlcmZvcm1BY3Rpb25fKGFjdGlvbiwgY29udGV4dCwgcGF5bG9hZCwgdXBkYXRlT3B0cywgY29ubk9wdHMpIHsgICAgICAgICAgICBcbiAgICAgICAgY29uc3QgY3VycmVudFN0YXRlID0gYXdhaXQgdGhpcy5zdGF0ZUZldGNoZXJfKHRoaXMuYXBwLCBjb250ZXh0LCBjb25uT3B0cyk7XG4gICAgICAgIFxuICAgICAgICBjb25zdCB0cmFuc2l0aW9ucyA9IHRoaXMudHJhbnNpdGlvbnNbY3VycmVudFN0YXRlXTsgICAgXG4gICAgICAgIGlmICghdHJhbnNpdGlvbnMpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBJbnZhbGlkQXJndW1lbnQoYFN0YXRlIFwiJHtjdXJyZW50U3RhdGV9XCIgcnVsZXMgbm90IGZvdW5kIGluIHRoZSB0cmFuc2l0aW9uIHRhYmxlLmApO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgcnVsZSA9IHRyYW5zaXRpb25zICYmIHRyYW5zaXRpb25zW2FjdGlvbl07XG4gICAgICAgIGlmICghcnVsZSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEZvcmJpZGRlbihgQWN0aW9uIFwiJHthY3Rpb259XCIgaXMgbm90IGFsbG93ZWQgaW4gXCIke2N1cnJlbnRTdGF0ZX1cIiBzdGF0ZS5gKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChydWxlLndoZW4pIHtcbiAgICAgICAgICAgIGNvbnN0IFsgYWxsb3dlZCwgZGlzYWxsb3dlZFJlYXNvbiBdID0gYXdhaXQgcnVsZS53aGVuKHRoaXMuYXBwLCBjb250ZXh0KTtcbiAgICAgICAgICAgIGlmICghYWxsb3dlZCkge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBGb3JiaWRkZW4oZGlzYWxsb3dlZFJlYXNvbiB8fCBgVGhlIGN1cnJlbnQgc3RhdGUgZG9lcyBub3QgbWVldCB0aGUgcmVxdWlyZW1lbnRzIG9mIFwiJHthY3Rpb259XCIgYWN0aW9uLmApO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgZW50aXR5VXBkYXRlID0gKHJ1bGUuYmVmb3JlICYmIChhd2FpdCBydWxlLmJlZm9yZSh0aGlzLmFwcCwgY29udGV4dCwgcGF5bG9hZCkpKSB8fCB7IC4uLnBheWxvYWQgfTtcbiAgICAgICAgY29uc3QgWyBhY3R1YWxseVVwZGF0ZWQsIHVwZGF0ZVJlc3VsdCBdID0gYXdhaXQgdGhpcy5zdGF0ZVVwZGF0ZXJfKHRoaXMuYXBwLCBjb250ZXh0LCBlbnRpdHlVcGRhdGUsIHJ1bGUudGFyZ2V0LCB1cGRhdGVPcHRzLCBjb25uT3B0cyk7XG5cbiAgICAgICAgaWYgKGFjdHVhbGx5VXBkYXRlZCAmJiBydWxlLmFmdGVyKSB7XG4gICAgICAgICAgICBhd2FpdCBydWxlLmFmdGVyKHRoaXMuYXBwLCBjb250ZXh0LCBjb25uT3B0cyk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdXBkYXRlUmVzdWx0O1xuICAgIH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPSBGaW5pdGVTdGF0ZU1hY2hpbmU7Il19