{"version":3,"sources":["Graph.js"],"names":["TopoSort","require","_","Graph","constructor","json","topo","nodes","cloneDeep","isEmpty","edges","forOwn","targets","source","add","startNodes","endNodes","hasNode","key","getNode","setNode","value","setEdge","sourceNode","targetNode","Error","getTargetNodes","Array","from","mapOfDependents","getSourceNodes","mapOfDependencies","calcStartEnd","seq","sort","takeWhile","e","hasDependency","takeRightWhile","hasDependent","length","Object","keys","toJSON","mapValues","module","exports"],"mappings":"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","sourcesContent":["const TopoSort = require('./TopoSort');\nconst { _ } = require('@genx/july');\n\nclass Graph {\n    constructor(json) {\n        this.topo = new TopoSort();\n\n        if (json) {\n            this.nodes = _.cloneDeep(json.nodes);\n            if (!_.isEmpty(json.edges)) {\n                _.forOwn(json.edges, (targets, source) => {\n                    this.topo.add(source, targets);\n                });\n            }\n            this.startNodes = json.startNodes;\n            this.endNodes = json.endNodes;\n        } else {\n            this.nodes = {};\n        }\n    }\n\n    hasNode(key) {\n        return key in this.nodes;\n    }\n\n    getNode(key) {\n        return this.nodes[key];\n    }\n\n    setNode(key, value) {\n        this.nodes[key] = value;\n        return this;\n    }\n\n    setEdge(sourceNode, targetNode) {\n        if (!this.hasNode(sourceNode)) {\n            throw new Error(`Source node [${sourceNode}] not exists.`);\n        }\n        if (!this.hasNode(targetNode)) {\n            throw new Error(`Target node [${targetNode}] not exists.`);\n        }\n        this.topo.add(sourceNode, targetNode);\n        return this;\n    }\n\n    getTargetNodes(sourceNode) {\n        return Array.from(this.topo.mapOfDependents[sourceNode]);\n    }\n\n    getSourceNodes(targetNode) {\n        return Array.from(this.topo.mapOfDependencies[targetNode]);\n    }\n\n    calcStartEnd() {\n        const seq = this.topo.sort();\n        this.startNodes = _.takeWhile(seq, (e) => !this.topo.hasDependency(e));\n        this.endNodes = _.takeRightWhile(\n            seq,\n            (e) => !this.topo.hasDependent(e)\n        );\n\n        if (this.startNodes.length === 0) {\n            this.startNodes = Object.keys(this.nodes);\n        }\n\n        if (this.endNodes.length === 0) {\n            this.endNodes = Object.keys(this.nodes);\n        }\n\n        return this;\n    }\n\n    toJSON() {\n        return {\n            nodes: this.nodes,\n            edges: _.mapValues(this.topo.mapOfDependents, (nodes) =>\n                Array.from(nodes)\n            ),\n            startNodes: this.startNodes,\n            endNodes: this.endNodes,\n        };\n    }\n}\n\nmodule.exports = Graph;\n"]}