"use strict";

require("source-map-support/register");

const {
  _,
  eachAsync_
} = require('rk-utils');

const buildReason = reason => Array.isArray(reason) ? reason.join(' or ') : reason;

class StateMachine {
  constructor(transitionTable, stateFetcher, dataReader, dataWriter) {
    this.transitions = transitionTable;
    this.stateFetcher_ = stateFetcher;
    this.dataReader_ = dataReader;
    this.dataWriter_ = dataWriter;
  }

  async getAllowedActions_(context, withDisallowedReason) {
    const currentState = await this.stateFetcher_(context);
    const transitions = this.transitions[currentState];
    const allowed = [],
          disallowed = [];
    await eachAsync_(transitions, async (rule, action) => {
      const result = await rule.pre_(context);

      if (result.allowed) {
        allowed.push({
          action,
          desc: rule.desc,
          targetState: rule.target
        });
      } else if (withDisallowedReason) {
        disallowed.push({
          action,
          desc: rule.desc,
          targetState: rule.target,
          reason: result.reason
        });
      }
    });
    const ret = {
      allowed
    };

    if (withDisallowedReason) {
      ret.disallowed = disallowed;
    }

    return ret;
  }

  async performAction_(context, action, payload) {
    entity = await this.ensureEntityWithState_(entity, connOpts);
    const currentState = entity[this.stateField];
    const transitions = this.transitions[currentState];
    const rule = transitions && transitions[action];

    if (!rule) {
      throw new BadRequest(`The action "${action}" is not available when ${this.stateField} is "${currentState}".`);
    }

    if (rule.pre_) {
      const result = await rule.pre_(ctx, entity);

      if (!result.allowed) {
        throw new Forbidden(`The current state of "${this.entityModel.meta.name}" does not meet the requirements of "${action}" action.`, {
          reason: buildReason(result.reason)
        });
      }
    }

    let entityUpdate = rule.transform_ && (await rule.transform_(ctx, entity, payload)) || { ...payload
    };

    if (rule.target) {
      entityUpdate[this.stateField] = rule.target;
    }

    let where = {
      $query: this.keyOfEntity(entity),
      $retrieveDbResult: true
    };

    if (rule.trigger_) {
      where.$retrieveUpdated = true;
    }

    let updated = await this.entityModel.updateOne_(entityUpdate, where, connOpts);

    if (where.$result.affectedRows === 0) {
      throw new ServerError(`Nothing is changed when performing action "${action}" on ${this.stateField} being "${currentState}".`);
    }

    if (rule.trigger_) {
      await rule.trigger_(ctx, updated);
    }

    return updated;
  }

}

StateMachine.ACTION_ALLOWED = {
  allowed: true
};

StateMachine.actionDisallow = reason => ({
  allowed: false,
  reason
});

module.exports = StateMachine;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9TdGF0ZU1hY2hpbmUuanMiXSwibmFtZXMiOlsiXyIsImVhY2hBc3luY18iLCJyZXF1aXJlIiwiYnVpbGRSZWFzb24iLCJyZWFzb24iLCJBcnJheSIsImlzQXJyYXkiLCJqb2luIiwiU3RhdGVNYWNoaW5lIiwiY29uc3RydWN0b3IiLCJ0cmFuc2l0aW9uVGFibGUiLCJzdGF0ZUZldGNoZXIiLCJkYXRhUmVhZGVyIiwiZGF0YVdyaXRlciIsInRyYW5zaXRpb25zIiwic3RhdGVGZXRjaGVyXyIsImRhdGFSZWFkZXJfIiwiZGF0YVdyaXRlcl8iLCJnZXRBbGxvd2VkQWN0aW9uc18iLCJjb250ZXh0Iiwid2l0aERpc2FsbG93ZWRSZWFzb24iLCJjdXJyZW50U3RhdGUiLCJhbGxvd2VkIiwiZGlzYWxsb3dlZCIsInJ1bGUiLCJhY3Rpb24iLCJyZXN1bHQiLCJwcmVfIiwicHVzaCIsImRlc2MiLCJ0YXJnZXRTdGF0ZSIsInRhcmdldCIsInJldCIsInBlcmZvcm1BY3Rpb25fIiwicGF5bG9hZCIsImVudGl0eSIsImVuc3VyZUVudGl0eVdpdGhTdGF0ZV8iLCJjb25uT3B0cyIsInN0YXRlRmllbGQiLCJCYWRSZXF1ZXN0IiwiY3R4IiwiRm9yYmlkZGVuIiwiZW50aXR5TW9kZWwiLCJtZXRhIiwibmFtZSIsImVudGl0eVVwZGF0ZSIsInRyYW5zZm9ybV8iLCJ3aGVyZSIsIiRxdWVyeSIsImtleU9mRW50aXR5IiwiJHJldHJpZXZlRGJSZXN1bHQiLCJ0cmlnZ2VyXyIsIiRyZXRyaWV2ZVVwZGF0ZWQiLCJ1cGRhdGVkIiwidXBkYXRlT25lXyIsIiRyZXN1bHQiLCJhZmZlY3RlZFJvd3MiLCJTZXJ2ZXJFcnJvciIsIkFDVElPTl9BTExPV0VEIiwiYWN0aW9uRGlzYWxsb3ciLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiOzs7O0FBQUEsTUFBTTtBQUFFQSxFQUFBQSxDQUFGO0FBQUtDLEVBQUFBO0FBQUwsSUFBb0JDLE9BQU8sQ0FBQyxVQUFELENB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QUFOO0FBQ0g7O0FBRUQsV0FBT0EsT0FBUDtBQUNIOztBQXBHYzs7QUFBYjdDLFksQ0FDS2tELGMsR0FBaUI7QUFBRXBDLEVBQUFBLE9BQU8sRUFBRTtBQUFYLEM7O0FBRHRCZCxZLENBRUttRCxjLEdBQWtCdkQsTUFBRCxLQUFhO0FBQUVrQixFQUFBQSxPQUFPLEVBQUUsS0FBWDtBQUFrQmxCLEVBQUFBO0FBQWxCLENBQWIsQzs7QUFxRzVCd0QsTUFBTSxDQUFDQyxPQUFQLEdBQWlCckQsWUFBakIiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCB7IF8sIGVhY2hBc3luY18gfSA9IHJlcXVpcmUoJ3JrLXV0aWxzJyk7XG5cbmNvbnN0IGJ1aWxkUmVhc29uID0gcmVhc29uID0+IEFycmF5LmlzQXJyYXkocmVhc29uKSA/IHJlYXNvbi5qb2luKCcgb3IgJykgOiByZWFzb247XG5cbi8qKlxuICogXG4gKiBBY3Rpb24gcnVsZTogXG4gKiAgcHJlXzogcHJlIHRyYW5zaXRpb24gY29uZGl0aW9uIGNoZWNrXG4gKiAgdHJhbnNmb3JtXzogdHJhbnNmb3JtaW5nIGJlZm9yZSBhcHBseWluZyB0byB0aGUgc3RhdGUgXG4gKiAgdHJpZ2dlcl86IHRyaWdnZXIgYW5vdGhlciBhY3Rpb24gYWZ0ZXIgdHJhbnNpdGlvblxuICovXG5cbmNsYXNzIFN0YXRlTWFjaGluZSB7XG4gICAgc3RhdGljIEFDVElPTl9BTExPV0VEID0geyBhbGxvd2VkOiB0cnVlIH07XG4gICAgc3RhdGljIGFjdGlvbkRpc2FsbG93ID0gKHJlYXNvbikgPT4gKHsgYWxsb3dlZDogZmFsc2UsIHJlYXNvbiB9KTsgXG4gICAgXG4gICAgY29uc3RydWN0b3IodHJhbnNpdGlvblRhYmxlLCBzdGF0ZUZldGNoZXIsIGRhdGFSZWFkZXIsIGRhdGFXcml0ZXIpIHtcbiAgICAgICAgdGhpcy50cmFuc2l0aW9ucyA9IHRyYW5zaXRpb25UYWJsZTtcbiAgICAgICAgdGhpcy5zdGF0ZUZldGNoZXJfID0gc3RhdGVGZXRjaGVyO1xuICAgICAgICB0aGlzLmRhdGFSZWFkZXJfID0gZGF0YVJlYWRlcjtcbiAgICAgICAgdGhpcy5kYXRhV3JpdGVyXyA9IGRhdGFXcml0ZXI7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0IGEgbGlzdCBvZiBhbGxvd2VkIGFjdGlvbnMgYmFzZWQgb24gdGhlIGN1cnJlbnQgc3RhdGUuICAgICBcbiAgICAgKiBAcGFyYW0geyp9IGNvbnRleHQgXG4gICAgICovXG4gICAgYXN5bmMgZ2V0QWxsb3dlZEFjdGlvbnNfKGNvbnRleHQsIHdpdGhEaXNhbGxvd2VkUmVhc29uKSB7XG4gICAgICAgIGNvbnN0IGN1cnJlbnRTdGF0ZSA9IGF3YWl0IHRoaXMuc3RhdGVGZXRjaGVyXyhjb250ZXh0KTtcblxuICAgICAgICAvL2Zyb20gc3RhdGVcbiAgICAgICAgY29uc3QgdHJhbnNpdGlvbnMgPSB0aGlzLnRyYW5zaXRpb25zW2N1cnJlbnRTdGF0ZV07ICAgIFxuICAgICAgICBjb25zdCBhbGxvd2VkID0gW10sIGRpc2FsbG93ZWQgPSBbXTsgICAgXG5cbiAgICAgICAgYXdhaXQgZWFjaEFzeW5jXyh0cmFuc2l0aW9ucywgYXN5bmMgKHJ1bGUsIGFjdGlvbikgPT4ge1xuICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgcnVsZS5wcmVfKGNvbnRleHQpO1xuXG4gICAgICAgICAgICBpZiAocmVzdWx0LmFsbG93ZWQpIHtcbiAgICAgICAgICAgICAgICBhbGxvd2VkLnB1c2goe1xuICAgICAgICAgICAgICAgICAgICBhY3Rpb24sXG4gICAgICAgICAgICAgICAgICAgIGRlc2M6IHJ1bGUuZGVzYyxcbiAgICAgICAgICAgICAgICAgICAgdGFyZ2V0U3RhdGU6IHJ1bGUudGFyZ2V0XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKHdpdGhEaXNhbGxvd2VkUmVhc29uKSB7XG4gICAgICAgICAgICAgICAgZGlzYWxsb3dlZC5wdXNoKHtcbiAgICAgICAgICAgICAgICAgICAgYWN0aW9uLFxuICAgICAgICAgICAgICAgICAgICBkZXNjOiBydWxlLmRlc2MsXG4gICAgICAgICAgICAgICAgICAgIHRhcmdldFN0YXRlOiBydWxlLnRhcmdldCxcbiAgICAgICAgICAgICAgICAgICAgcmVhc29uOiByZXN1bHQucmVhc29uXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGNvbnN0IHJldCA9IHtcbiAgICAgICAgICAgIGFsbG93ZWRcbiAgICAgICAgfTtcblxuICAgICAgICBpZiAod2l0aERpc2FsbG93ZWRSZWFzb24pIHtcbiAgICAgICAgICAgIHJldC5kaXNhbGxvd2VkID0gZGlzYWxsb3dlZDtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiByZXQ7XG4gICAgfVxuICAgIFxuICAgIC8qKlxuICAgICAqIFBlcmZvcm0gdGhlIHNwZWNpZmllZCBhY3Rpb24uXG4gICAgICogQHBhcmFtIHsqfSBjb250ZXh0IFxuICAgICAqIEBwYXJhbSB7Kn0gYWN0aW9uIFxuICAgICAqIEBwYXJhbSB7Kn0gcGF5bG9hZCBcbiAgICAgKi9cbiAgICBhc3luYyBwZXJmb3JtQWN0aW9uXyhjb250ZXh0LCBhY3Rpb24sIHBheWxvYWQpIHsgICAgXG4gICAgICAgIGVudGl0eSA9IGF3YWl0IHRoaXMuZW5zdXJlRW50aXR5V2l0aFN0YXRlXyhlbnRpdHksIGNvbm5PcHRzKTtcbiAgICAgICAgY29uc3QgY3VycmVudFN0YXRlID0gZW50aXR5W3RoaXMuc3RhdGVGaWVsZF07XG4gICAgICAgIFxuICAgICAgICBjb25zdCB0cmFuc2l0aW9ucyA9IHRoaXMudHJhbnNpdGlvbnNbY3VycmVudFN0YXRlXTsgICAgXG4gICAgICAgIGNvbnN0IHJ1bGUgPSB0cmFuc2l0aW9ucyAmJiB0cmFuc2l0aW9uc1thY3Rpb25dO1xuXG4gICAgICAgIGlmICghcnVsZSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3QoYFRoZSBhY3Rpb24gXCIke2FjdGlvbn1cIiBpcyBub3QgYXZhaWxhYmxlIHdoZW4gJHt0aGlzLnN0YXRlRmllbGR9IGlzIFwiJHtjdXJyZW50U3RhdGV9XCIuYCk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAocnVsZS5wcmVfKSB7XG4gICAgICAgICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBydWxlLnByZV8oY3R4LCBlbnRpdHkpO1xuICAgICAgICAgICAgaWYgKCFyZXN1bHQuYWxsb3dlZCkge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBGb3JiaWRkZW4oYFRoZSBjdXJyZW50IHN0YXRlIG9mIFwiJHt0aGlzLmVudGl0eU1vZGVsLm1ldGEubmFtZX1cIiBkb2VzIG5vdCBtZWV0IHRoZSByZXF1aXJlbWVudHMgb2YgXCIke2FjdGlvbn1cIiBhY3Rpb24uYCwgeyByZWFzb246IGJ1aWxkUmVhc29uKHJlc3VsdC5yZWFzb24pIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgbGV0IGVudGl0eVVwZGF0ZSA9IChydWxlLnRyYW5zZm9ybV8gJiYgKGF3YWl0IHJ1bGUudHJhbnNmb3JtXyhjdHgsIGVudGl0eSwgcGF5bG9hZCkpKSB8fCB7IC4uLnBheWxvYWQgfTsgIFxuICAgICAgICBpZiAocnVsZS50YXJnZXQpIHtcbiAgICAgICAgICAgIGVudGl0eVVwZGF0ZVt0aGlzLnN0YXRlRmllbGRdID0gcnVsZS50YXJnZXQ7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgd2hlcmUgPSB7XG4gICAgICAgICAgICAkcXVlcnk6IHRoaXMua2V5T2ZFbnRpdHkoZW50aXR5KSxcbiAgICAgICAgICAgICRyZXRyaWV2ZURiUmVzdWx0OiB0cnVlXG4gICAgICAgIH07XG5cbiAgICAgICAgaWYgKHJ1bGUudHJpZ2dlcl8pIHtcbiAgICAgICAgICAgIHdoZXJlLiRyZXRyaWV2ZVVwZGF0ZWQgPSB0cnVlO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IHVwZGF0ZWQgPSBhd2FpdCB0aGlzLmVudGl0eU1vZGVsLnVwZGF0ZU9uZV8oZW50aXR5VXBkYXRlLCB3aGVyZSwgY29ubk9wdHMpO1xuICAgICAgICBpZiAod2hlcmUuJHJlc3VsdC5hZmZlY3RlZFJvd3MgPT09IDApIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBTZXJ2ZXJFcnJvcihgTm90aGluZyBpcyBjaGFuZ2VkIHdoZW4gcGVyZm9ybWluZyBhY3Rpb24gXCIke2FjdGlvbn1cIiBvbiAke3RoaXMuc3RhdGVGaWVsZH0gYmVpbmcgXCIke2N1cnJlbnRTdGF0ZX1cIi5gKVxuICAgICAgICB9XG4gICAgXG4gICAgICAgIGlmIChydWxlLnRyaWdnZXJfKSB7XG4gICAgICAgICAgICBhd2FpdCBydWxlLnRyaWdnZXJfKGN0eCwgdXBkYXRlZCk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdXBkYXRlZDtcbiAgICB9XG59XG5cbm1vZHVsZS5leHBvcnRzID0gU3RhdGVNYWNoaW5lOyJdfQ==