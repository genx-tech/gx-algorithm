{"version":3,"sources":["../../src/__tests__/FiniteStateMachine.spec.js"],"sourcesContent":["'use strict';\n\nconst { sleep_ } = require('@genx/july');\nconst FSM = require('../FiniteStateMachine');\n\ndescribe('unit:fsm', function () {\n    it('bvt', async function () {\n        const atimer = {\n            state: 'shutdown',\n            time: 0,\n            handle: null,\n        };\n\n        const transitionTable = {\n            shutdown: {\n                start: {\n                    target: 'running',\n                    after: (_, timer) => {\n                        console.log('trigger');\n                        timer.handle = setInterval(() => {\n                            timer.time++;\n                        }, 100);\n                    },\n                },\n                stop: {},\n            },\n            running: {\n                start: {\n                    when: (_, timer) => {\n                        if (timer.time > 10) {\n                            return [true];\n                        } else {\n                            return [false, 'not passed 1 second'];\n                        }\n                    },\n                    before: (_, timer) => {\n                        return {\n                            time: 0,\n                        };\n                    },\n                },\n                stop: {\n                    target: 'paused',\n                    when: (_, timer) => {\n                        if (timer.time > 10) {\n                            return [true];\n                        } else {\n                            return [false, 'not passed 1 second'];\n                        }\n                    },\n                    after: (_, timer) => {\n                        if (timer.handle) {\n                            clearInterval(timer.handle);\n                            timer.handle = null;\n                        }\n                    },\n                },\n            },\n            paused: {\n                start: {\n                    target: 'running',\n                    when: (_, timer) => {\n                        if (timer.handle) return [false, 'already started'];\n                        return [true];\n                    },\n                    after: (_, timer) => {\n                        timer.handle = setInterval(() => {\n                            timer.time++;\n                        }, 100);\n                    },\n                },\n                stop: {\n                    target: 'shutdown',\n                    when: (_, timer) => {\n                        if (timer.handle) return [false, 'not paused'];\n                        return [true];\n                    },\n                    before: (_, timer) => {\n                        return {\n                            time: 0,\n                        };\n                    },\n                },\n            },\n        };\n\n        const fsm = new FSM(\n            null,\n            transitionTable,\n            (_, timer) => timer.state,\n            (_, timer, data, targetState) => {\n                if (targetState) {\n                    data = { ...data, state: targetState };\n                }\n\n                Object.assign(timer, data);\n\n                return [true];\n            }\n        );\n\n        let actions = await fsm.getAllowedActions_(atimer, true);\n        actions.allowed.length.should.be.exactly(2);\n        actions.disallowed.length.should.be.exactly(0);\n\n        await fsm.performAction_('start', atimer);\n        atimer.state.should.be.exactly('running');\n\n        actions = await fsm.getAllowedActions_(atimer, true);\n        actions.allowed.length.should.be.exactly(0);\n        actions.disallowed.length.should.be.exactly(2);\n        actions.disallowed[0].reason.should.be.exactly('not passed 1 second');\n\n        await sleep_(1200);\n\n        actions = await fsm.getAllowedActions_(atimer, true);\n        actions.allowed.length.should.be.exactly(2);\n        actions.disallowed.length.should.be.exactly(0);\n\n        await fsm.performAction_('stop', atimer);\n        atimer.state.should.be.exactly('paused');\n\n        actions = await fsm.getAllowedActions_(atimer, true);\n        actions.allowed.length.should.be.exactly(2);\n        actions.disallowed.length.should.be.exactly(0);\n\n        await fsm.performAction_('start', atimer);\n        atimer.state.should.be.exactly('running');\n\n        actions = await fsm.getAllowedActions_(atimer, true);\n        actions.allowed.length.should.be.exactly(2);\n        actions.disallowed.length.should.be.exactly(0);\n\n        await fsm.performAction_('stop', atimer);\n        atimer.state.should.be.exactly('paused');\n\n        await fsm.performAction_('stop', atimer);\n        atimer.state.should.be.exactly('shutdown');\n    });\n});\n"],"names":["sleep_","require","FSM","describe","it","atimer","state","time","handle","transitionTable","shutdown","start","target","after","_","timer","console","log","setInterval","stop","running","when","before","clearInterval","paused","fsm","data","targetState","Object","assign","actions","getAllowedActions_","allowed","length","should","be","exactly","disallowed","performAction_","reason"],"mappings":"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"}