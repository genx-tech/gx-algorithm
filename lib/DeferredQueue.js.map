{"version":3,"sources":["../src/DeferredQueue.js"],"sourcesContent":["/**\n * id, job, dueAt, status, batchId (default '*'), dispatchedAt, lockFlag\n * uniqueKeys: [ job, batchId ]\n *\n */\nconst timestampOffset = 1640995200000;\n\nclass DeferredQueue {\n    constructor(app, storageModel, processTimeout) {\n        this.app = app;\n        this.storage = this.app.model(storageModel);\n        this.processTimeout = processTimeout || 600000;\n    }\n\n    genreateBatchId() {\n        return (Date.now() - timestampOffset).toString();\n    }\n\n    async postJobRequest_(job, deferedTime) {\n        const now = this.app.now();\n        const due = now.plus({ milliseconds: deferedTime || 3000 });\n\n        const queuedJob = await this.storage.create_(\n            {\n                job: JSON.stringify(job),\n                dueAt: due,\n                batchId: '*',\n            },\n            null,\n            {\n                insertIgnore: true,\n            }\n        );\n\n        return queuedJob;\n    }\n\n    async popExpiredRequests_() {\n        const expired = this.app\n            .now()\n            .minus({ milliseconds: this.processTimeout });\n\n        const deleteOptions = {\n            $query: {\n                batchId: { $neq: '*' },\n                dispatchedAt: { $lte: expired },\n                lockerId: { $exists: false },\n            },\n            $retrieveDbResult: true   \n        }            \n\n        await this.remove_(deleteOptions);\n\n        return deleteOptions.$result.affectedRows;\n    }\n\n    async processDueRequests_() {\n        const now = this.app.now();\n        const batchId = this.genreateBatchId();\n\n        const updated = await this.storage.updateMany_(\n            {\n                batchId,\n                dispatchedAt: now,\n            },\n            {\n                $query: {\n                    batchId: '*',\n                    dueAt: { $lte: now },\n                },\n                $retrieveUpdated: {\n                    $query: {\n                        batchId,\n                    },\n                },\n            }\n        );\n\n        return updated;\n    }\n\n    async remove_(conditon) {\n        await this.storage.deleteMany_(conditon);\n    }\n\n    async removeById_(id) {\n        await this.storage.deleteOne_(id);\n    }\n\n    async clearQueue_() {\n        await this.storage.deleteAll_();\n    }\n\n    async getBatchStatus_() {\n        const batchStats = await this.storage.findAll_({\n            $projection: [\n                'batchId',\n                this.storage.db.connector.queryCount(null, 'batchId'),\n            ],\n            $query: {\n                lockerId: { $exists: false },\n            },\n            $groupBy: ['batchId'],\n            $skipOrm: true,\n        });\n\n        let pending = 0;\n        let processing = 0;\n        const batches = {};\n\n        batchStats.forEach((batch) => {\n            if (batch[0] === '*') {\n                pending = batch[1];\n            } else {\n                batches[batch[0]] = batch[1];\n                processing += batch[1];\n            }\n        });\n\n        return {\n            numPending: pending,\n            numProcessing: processing,\n            batches,\n        };\n    }\n}\n\nmodule.exports = DeferredQueue;\n"],"names":["timestampOffset","DeferredQueue","constructor","app","storageModel","processTimeout","storage","model","genreateBatchId","Date","now","toString","postJobRequest_","job","deferedTime","due","plus","milliseconds","queuedJob","create_","JSON","stringify","dueAt","batchId","insertIgnore","popExpiredRequests_","expired","minus","deleteOptions","$query","$neq","dispatchedAt","$lte","lockerId","$exists","$retrieveDbResult","remove_","$result","affectedRows","processDueRequests_","updated","updateMany_","$retrieveUpdated","conditon","deleteMany_","removeById_","id","deleteOne_","clearQueue_","deleteAll_","getBatchStatus_","batchStats","findAll_","$projection","db","connector","queryCount","$groupBy","$skipOrm","pending","processing","batches","forEach","batch","numPending","numProcessing","module","exports"],"mappings":"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"}