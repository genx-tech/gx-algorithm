{"version":3,"sources":["../src/FiniteStateMachine.js"],"sourcesContent":["const { eachAsync_ } = require('@genx/july');\nconst { InvalidArgument, Forbidden } = require('@genx/error');\n\n/**\n *\n * Action rule:\n *  desc: description of this transition\n *  when: pre transition condition check\n *  target: target state\n *  before: transforming before applying to the state\n *  after: trigger another action after transition\n */\n\nclass FiniteStateMachine {\n    static OK = [true];\n    static fail = (reason) => [false, reason];\n    static triggerAll_ =\n        (array) =>\n        (...args) =>\n            eachAsync_(array, (action_) => action_(...args));\n\n    static ifAny =\n        (array) =>\n        async (...args) => {\n            const l = array.length;\n            const reason = [];\n\n            for (let i = 0; i < l; i++) {\n                const checker_ = array[i];\n\n                const [allowed, disallowedReason] = await checker_(...args);\n                if (allowed) {\n                    return FiniteStateMachine.OK;\n                }\n\n                reason.push(disallowedReason);\n            }\n\n            return FiniteStateMachine.fail(\n                'None of the required conditions met.\\n' + reason.join('\\n')\n            );\n        };\n\n    static ifAll =\n        (array) =>\n        async (...args) => {\n            const l = array.length;\n\n            for (let i = 0; i < l; i++) {\n                const checker_ = array[i];\n\n                const [allowed, disallowedReason] = await checker_(...args);\n                if (!allowed) {\n                    return FiniteStateMachine.fail(disallowedReason);\n                }\n            }\n\n            return FiniteStateMachine.OK;\n        };\n\n    constructor(app, transitionTable, stateFetcher, stateUpdater) {\n        this.app = app;\n\n        this.transitions = transitionTable;\n        this.stateFetcher_ = stateFetcher;\n        this.stateUpdater_ = stateUpdater;\n    }\n\n    /**\n     * Get a list of allowed actions based on the current state.\n     * @param {*} context\n     * @param {boolean} withDisallowedReason\n     */\n    async getAllowedActions_(context, withDisallowedReason) {\n        const currentState = await this.stateFetcher_(this.app, context);\n\n        // from state\n        const transitions = this.transitions[currentState];\n        if (!transitions) {\n            throw new InvalidArgument(\n                `State \"${currentState}\" rules not found in the transition table.`\n            );\n        }\n\n        const allowed = [];\n        const disallowed = [];\n\n        await eachAsync_(transitions, async (rule, action) => {\n            const [actionAllowed, disallowedReason] =\n                (rule.when && (await rule.when(this.app, context))) ||\n                FiniteStateMachine.OK;\n\n            if (actionAllowed) {\n                allowed.push({\n                    action,\n                    desc: rule.desc,\n                    targetState: rule.target,\n                });\n            } else if (withDisallowedReason) {\n                disallowed.push({\n                    action,\n                    desc: rule.desc,\n                    targetState: rule.target,\n                    reason: disallowedReason,\n                });\n            }\n        });\n\n        const ret = {\n            allowed,\n        };\n\n        if (withDisallowedReason) {\n            ret.disallowed = disallowed;\n        }\n\n        return ret;\n    }\n\n    /**\n     * Perform the specified action.\n     * @param {*} action\n     * @param {*} context\n     * @param {*} payload\n     * @param {*} updateOpts\n     * @param {*} connOpts\n     */\n    async performAction_(action, context, payload, updateOpts, connOpts) {\n        const currentState = await this.stateFetcher_(\n            this.app,\n            context,\n            connOpts\n        );\n\n        const transitions = this.transitions[currentState];\n        if (!transitions) {\n            throw new InvalidArgument(\n                `State \"${currentState}\" rules not found in the transition table.`\n            );\n        }\n\n        const rule = transitions && transitions[action];\n        if (!rule) {\n            throw new Forbidden(\n                `Action \"${action}\" is not allowed in \"${currentState}\" state.`\n            );\n        }\n\n        if (rule.when) {\n            const [allowed, disallowedReason] = await rule.when(\n                this.app,\n                context\n            );\n            if (!allowed) {\n                throw new Forbidden(\n                    disallowedReason ||\n                        `The current state does not meet the requirements of \"${action}\" action.`\n                );\n            }\n        }\n\n        const entityUpdate = (rule.before &&\n            (await rule.before(this.app, context, payload))) || { ...payload };\n        const [actuallyUpdated, updateResult] = await this.stateUpdater_(\n            this.app,\n            context,\n            entityUpdate,\n            rule.target,\n            updateOpts,\n            connOpts\n        );\n\n        if (actuallyUpdated && rule.after) {\n            await rule.after(this.app, context, connOpts);\n        }\n\n        return updateResult;\n    }\n}\n\nmodule.exports = FiniteStateMachine;\n"],"names":["eachAsync_","require","InvalidArgument","Forbidden","FiniteStateMachine","getAllowedActions_","context","withDisallowedReason","currentState","stateFetcher_","app","transitions","allowed","disallowed","rule","action","actionAllowed","disallowedReason","when","OK","push","desc","targetState","target","reason","ret","performAction_","payload","updateOpts","connOpts","entityUpdate","before","actuallyUpdated","updateResult","stateUpdater_","after","constructor","transitionTable","stateFetcher","stateUpdater","fail","triggerAll_","array","args","action_","ifAny","l","length","i","checker_","join","ifAll","module","exports"],"mappings":"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"}