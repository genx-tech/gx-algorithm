"use strict";

require("source-map-support/register");

class DeferredQueue {
  constructor(app, storageModel, processTimeout) {
    this.app = app;
    this.storage = this.app.model(storageModel);
    this.processTimeout = processTimeout || 600000;
  }

  genreateBatchId() {
    const {
      Generators
    } = require('@genx/data');

    return Generators.shortid();
  }

  async postFutureJob_(job, deferedTime) {
    const now = this.app.now();
    const due = now.plus({
      milliseconds: deferedTime || 3000
    });
    const queuedJob = await this.storage.create_({
      job: JSON.stringify(job),
      dueAt: due,
      batchId: '*'
    }, null, {
      insertIgnore: true
    });
    return queuedJob;
  }

  async popExpiredJobs_() {
    const expired = this.app.now().minus({
      milliseconds: this.processTimeout
    });
    const batchId = this.genreateBatchId();
    const updated = await this.storage.updateMany_({
      batchId,
      lockFlag: true
    }, {
      $query: {
        batchId: {
          $neq: '*'
        },
        dispatchedAt: {
          $lte: expired
        },
        lockFlag: {
          $neq: true
        }
      },
      $retrieveUpdated: {
        $query: {
          batchId
        }
      }
    });
    await this.removeByBatch_(batchId);
    return updated;
  }

  async markDueJobs_() {
    const now = this.app.now();
    const batchId = this.genreateBatchId();
    const updated = await this.storage.updateMany_({
      batchId,
      dispatchedAt: now
    }, {
      $query: {
        batchId: '*',
        dueAt: {
          $lte: now
        }
      },
      $retrieveUpdated: {
        $query: {
          batchId
        }
      }
    });
    return updated;
  }

  async removeByBatch_(batchId) {
    await this.storage.deleteMany_({
      batchId
    });
  }

  async removeById_(id) {
    await this.storage.deleteOne_(id);
  }

  async clearQueue_() {
    await this.storage.deleteAll_();
  }

  async getBatchStatus_() {
    const batchStats = await this.storage.findAll_({
      $projection: ['batchId', this.storage.db.connector.queryCount(null, "batchId")],
      $query: {
        lockFlag: {
          $neq: 1
        }
      },
      $groupBy: ['batchId'],
      $skipOrm: true
    });
    let pending = 0,
        processing = 0,
        batches = {};
    batchStats.forEach(batch => {
      if (batch[0] === '*') {
        pending = batch[1];
      } else {
        batches[batch[0]] = batch[1];
        processing += batch[1];
      }
    });
    return {
      numPending: pending,
      numProcessing: processing,
      batches
    };
  }

}

module.exports = DeferredQueue;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9EZWZlcnJlZFF1ZXVlLmpzIl0sIm5hbWVzIjpbIkRlZmVycmVkUXVldWUiLCJjb25zdHJ1Y3RvciIsImFwcCIsInN0b3JhZ2VNb2RlbCIsInByb2Nlc3NUaW1lb3V0Iiwic3RvcmFnZSIsIm1vZGVsIiwiZ2VucmVhdGVCYXRjaElkIiwiR2VuZXJhdG9ycyIsInJlcXVpcmUiLCJzaG9ydGlkIiwicG9zdEZ1dHVyZUpvYl8iLCJqb2IiLCJkZWZlcmVkVGltZSIsIm5vdyIsImR1ZSIsInBsdXMiLCJtaWxsaXNlY29uZHMiLCJxdWV1ZWRKb2IiLCJjcmVhdGVfIiwiSlNPTiIsInN0cmluZ2lmeSIsImR1ZUF0IiwiYmF0Y2hJZCIsImluc2VydElnbm9yZSIsInBvcEV4cGlyZWRKb2JzXyIsImV4cGlyZWQiLCJtaW51cyIsInVwZGF0ZWQiLCJ1cGRhdGVNYW55XyIsImxvY2tGbGFnIiwiJHF1ZXJ5IiwiJG5lcSIsImRpc3BhdGNoZWRBdCIsIiRsdGUiLCIkcmV0cmlldmVVcGRhdGVkIiwicmVtb3ZlQnlCYXRjaF8iLCJtYXJrRHVlSm9ic18iLCJkZWxldGVNYW55XyIsInJlbW92ZUJ5SWRfIiwiaWQiLCJkZWxldGVPbmVfIiwiY2xlYXJRdWV1ZV8iLCJkZWxldGVBbGxfIiwiZ2V0QmF0Y2hTdGF0dXNfIiwiYmF0Y2hTdGF0cyIsImZpbmRBbGxfIiwiJHByb2plY3Rpb24iLCJkYiIsImNvbm5lY3RvciIsInF1ZXJ5Q291bnQiLCIkZ3JvdXBCeSIsIiRza2lwT3JtIiwicGVuZGluZyIsInByb2Nlc3NpbmciLCJiYXRjaGVzIiwiZm9yRWFjaCIsImJhdGNoIiwibnVtUGVuZGluZyIsIm51bVByb2Nlc3NpbmciLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiOzs7O0FBT0EsTUFBTUEsYUFBTixDQUFvQjtBQUNoQkMsRUFBQUEsV0FBVyxDQUFDQyxHQUFELEVBQU1DLFlBQU4sRUFBb0JDLGNBQXBCLEVBQW9DO0FBQzNDLFNBQUtGLEdBQUwsR0FB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SCxRQUFBQSxVQUFVLElBQUlHLEtBQUssQ0FBQyxDQUFELENBQW5CO0FBQ0g7QUFDSixLQVBEO0FBU0EsV0FBTztBQUNIQyxNQUFBQSxVQUFVLEVBQUVMLE9BRFQ7QUFFSE0sTUFBQUEsYUFBYSxFQUFFTCxVQUZaO0FBR0hDLE1BQUFBO0FBSEcsS0FBUDtBQUtIOztBQXJIZTs7QUF3SHBCSyxNQUFNLENBQUNDLE9BQVAsR0FBaUI3RCxhQUFqQiIsInNvdXJjZXNDb250ZW50IjpbIlxuLyoqXG4gKiBpZCwgam9iLCBkdWVBdCwgc3RhdHVzLCBiYXRjaElkIChkZWZhdWx0ICcqJyksIGRpc3BhdGNoZWRBdCwgbG9ja0ZsYWdcbiAqIHVuaXF1ZUtleXM6IFsgam9iLCBiYXRjaElkIF1cbiAqIFxuICogdG9kbzogYXV0b21hdGljYWxseSBjcmVhdGUgZGIgc3RydWN0dXJlIGlmIG5vdCBleGlzdFxuICovXG5jbGFzcyBEZWZlcnJlZFF1ZXVlIHsgICAgXG4gICAgY29uc3RydWN0b3IoYXBwLCBzdG9yYWdlTW9kZWwsIHByb2Nlc3NUaW1lb3V0KSB7XG4gICAgICAgIHRoaXMuYXBwID0gYXBwO1xuICAgICAgICB0aGlzLnN0b3JhZ2UgPSB0aGlzLmFwcC5tb2RlbChzdG9yYWdlTW9kZWwpO1xuICAgICAgICB0aGlzLnByb2Nlc3NUaW1lb3V0ID0gcHJvY2Vzc1RpbWVvdXQgfHwgNjAwMDAwO1xuICAgIH1cblxuICAgIGdlbnJlYXRlQmF0Y2hJZCgpIHtcbiAgICAgICAgY29uc3QgeyBHZW5lcmF0b3JzIH0gPSByZXF1aXJlKCdAZ2VueC9kYXRhJyk7XG4gICAgICAgIHJldHVybiBHZW5lcmF0b3JzLnNob3J0aWQoKTtcbiAgICB9XG5cbiAgICBhc3luYyBwb3N0RnV0dXJlSm9iXyhqb2IsIGRlZmVyZWRUaW1lKSB7XG4gICAgICAgIGNvbnN0IG5vdyA9IHRoaXMuYXBwLm5vdygpO1xuICAgICAgICBjb25zdCBkdWUgPSBub3cucGx1cyh7IG1pbGxpc2Vjb25kczogZGVmZXJlZFRpbWUgfHwgMzAwMCB9KTtcblxuICAgICAgICBjb25zdCBxdWV1ZWRKb2IgPSBhd2FpdCB0aGlzLnN0b3JhZ2UuY3JlYXRlXyh7XG4gICAgICAgICAgICBqb2I6IEpTT04uc3RyaW5naWZ5KGpvYiksXG4gICAgICAgICAgICBkdWVBdDogZHVlLFxuICAgICAgICAgICAgYmF0Y2hJZDogJyonXG4gICAgICAgIH0sIG51bGwsIHtcbiAgICAgICAgICAgIGluc2VydElnbm9yZTogdHJ1ZVxuICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gcXVldWVkSm9iO1xuICAgIH1cblxuICAgIGFzeW5jIHBvcEV4cGlyZWRKb2JzXygpIHtcbiAgICAgICAgY29uc3QgZXhwaXJlZCA9IHRoaXMuYXBwLm5vdygpLm1pbnVzKHsgbWlsbGlzZWNvbmRzOiB0aGlzLnByb2Nlc3NUaW1lb3V0IH0pO1xuICAgICAgICBjb25zdCBiYXRjaElkID0gdGhpcy5nZW5yZWF0ZUJhdGNoSWQoKTtcblxuICAgICAgICBjb25zdCB1cGRhdGVkID0gYXdhaXQgdGhpcy5zdG9yYWdlLnVwZGF0ZU1hbnlfKHsgICAgICAgICAgICBcbiAgICAgICAgICAgIGJhdGNoSWQsXG4gICAgICAgICAgICBsb2NrRmxhZzogdHJ1ZVxuICAgICAgICB9LCB7XG4gICAgICAgICAgICAkcXVlcnk6IHtcbiAgICAgICAgICAgICAgICBiYXRjaElkOiB7ICRuZXE6ICcqJyB9LFxuICAgICAgICAgICAgICAgIGRpc3BhdGNoZWRBdDogeyAkbHRlOiBleHBpcmVkIH0sXG4gICAgICAgICAgICAgICAgbG9ja0ZsYWc6IHsgJG5lcTogdHJ1ZSB9XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgJHJldHJpZXZlVXBkYXRlZDoge1xuICAgICAgICAgICAgICAgICRxdWVyeToge1xuICAgICAgICAgICAgICAgICAgICBiYXRjaElkXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICBhd2FpdCB0aGlzLnJlbW92ZUJ5QmF0Y2hfKGJhdGNoSWQpO1xuXG4gICAgICAgIHJldHVybiB1cGRhdGVkO1xuICAgIH1cblxuICAgIGFzeW5jIG1hcmtEdWVKb2JzXygpIHtcbiAgICAgICAgY29uc3Qgbm93ID0gdGhpcy5hcHAubm93KCk7XG4gICAgICAgIGNvbnN0IGJhdGNoSWQgPSB0aGlzLmdlbnJlYXRlQmF0Y2hJZCgpOyAgICAgICAgXG5cbiAgICAgICAgY29uc3QgdXBkYXRlZCA9IGF3YWl0IHRoaXMuc3RvcmFnZS51cGRhdGVNYW55Xyh7ICAgICAgICAgICAgXG4gICAgICAgICAgICBiYXRjaElkLFxuICAgICAgICAgICAgZGlzcGF0Y2hlZEF0OiBub3dcbiAgICAgICAgfSwge1xuICAgICAgICAgICAgJHF1ZXJ5OiB7XG4gICAgICAgICAgICAgICAgYmF0Y2hJZDogJyonLFxuICAgICAgICAgICAgICAgIGR1ZUF0OiB7ICRsdGU6IG5vdyB9XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgJHJldHJpZXZlVXBkYXRlZDoge1xuICAgICAgICAgICAgICAgICRxdWVyeToge1xuICAgICAgICAgICAgICAgICAgICBiYXRjaElkXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gdXBkYXRlZDtcbiAgICB9XG5cbiAgICBhc3luYyByZW1vdmVCeUJhdGNoXyhiYXRjaElkKSB7XG4gICAgICAgIGF3YWl0IHRoaXMuc3RvcmFnZS5kZWxldGVNYW55Xyh7IGJhdGNoSWQgfSk7XG4gICAgfVxuXG4gICAgYXN5bmMgcmVtb3ZlQnlJZF8oaWQpIHtcbiAgICAgICAgYXdhaXQgdGhpcy5zdG9yYWdlLmRlbGV0ZU9uZV8oaWQpO1xuICAgIH1cblxuICAgIGFzeW5jIGNsZWFyUXVldWVfKCkge1xuICAgICAgICBhd2FpdCB0aGlzLnN0b3JhZ2UuZGVsZXRlQWxsXygpO1xuICAgIH1cblxuICAgIGFzeW5jIGdldEJhdGNoU3RhdHVzXygpIHtcbiAgICAgICAgY29uc3QgYmF0Y2hTdGF0cyA9IGF3YWl0IHRoaXMuc3RvcmFnZS5maW5kQWxsXyh7XG4gICAgICAgICAgICAkcHJvamVjdGlvbjogW1xuICAgICAgICAgICAgICAgICdiYXRjaElkJyxcbiAgICAgICAgICAgICAgICB0aGlzLnN0b3JhZ2UuZGIuY29ubmVjdG9yLnF1ZXJ5Q291bnQobnVsbCwgXCJiYXRjaElkXCIpXG4gICAgICAgICAgICBdLFxuICAgICAgICAgICAgJHF1ZXJ5OiB7XG4gICAgICAgICAgICAgICAgbG9ja0ZsYWc6IHsgJG5lcTogMSB9XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgJGdyb3VwQnk6IFtcbiAgICAgICAgICAgICAgICAnYmF0Y2hJZCdcbiAgICAgICAgICAgIF0sXG4gICAgICAgICAgICAkc2tpcE9ybTogdHJ1ZVxuICAgICAgICB9KTtcblxuICAgICAgICBsZXQgcGVuZGluZyA9IDAsIHByb2Nlc3NpbmcgPSAwLCBiYXRjaGVzID0ge307XG5cbiAgICAgICAgYmF0Y2hTdGF0cy5mb3JFYWNoKGJhdGNoID0+IHtcbiAgICAgICAgICAgIGlmIChiYXRjaFswXSA9PT0gJyonKSB7XG4gICAgICAgICAgICAgICAgcGVuZGluZyA9IGJhdGNoWzFdO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBiYXRjaGVzW2JhdGNoWzBdXSA9IGJhdGNoWzFdO1xuICAgICAgICAgICAgICAgIHByb2Nlc3NpbmcgKz0gYmF0Y2hbMV07XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBudW1QZW5kaW5nOiBwZW5kaW5nLFxuICAgICAgICAgICAgbnVtUHJvY2Vzc2luZzogcHJvY2Vzc2luZyxcbiAgICAgICAgICAgIGJhdGNoZXNcbiAgICAgICAgfTtcbiAgICB9XG59XG5cbm1vZHVsZS5leHBvcnRzID0gRGVmZXJyZWRRdWV1ZTsiXX0=